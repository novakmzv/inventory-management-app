<form [formGroup]="batchForm" (ngSubmit)="onSubmit()">

  <!-- Información General del Lote -->
  <div class="mb-8">
    <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center gap-2">
      <lucide-icon [img]="Package" class="text-orange-600" size="20"></lucide-icon>
      Información del lote
    </h3>

    <div class="grid grid-cols-1 gap-4 sm:gap-6">
      <!-- Fecha de producción -->
      <div>
        <label for="production_date" class="block text-sm font-medium text-gray-700 mb-2">
          Fecha de producción *
        </label>
        <input
          type="date"
          id="production_date"
          formControlName="production_date"
          [class]="'w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 transition-colors ' +
                   (isFieldInvalid('production_date') ? 'border-red-500' : 'border-gray-300')">

        @if (isFieldInvalid('production_date')) {
          <p class="mt-1 text-sm text-red-600">{{ getFieldError('production_date') }}</p>
        }
      </div>

      <!-- Descripción -->
      <div>
        <label for="description" class="block text-sm font-medium text-gray-700 mb-2">
          Descripción (opcional)
        </label>
        <input
          type="text"
          id="description"
          formControlName="description"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500"
          placeholder="Descripción del lote">
      </div>
    </div>
  </div>

  <!-- Sección de Productos -->
  <div class="mb-8">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-lg font-medium text-gray-900">Productos del lote</h3>

      @if (hasAvailableProducts) {
        <button
          type="button"
          (click)="addProduct()"
          class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors">
          <lucide-icon [img]="Plus" size="16"></lucide-icon>
          Agregar producto
        </button>
      }
    </div>

    <!-- Sin productos disponibles -->
    @if (!hasAvailableProducts) {
      <div class="text-center py-8 bg-gray-50 rounded-lg">
        <p class="text-gray-600">No hay productos disponibles. Crea productos primero.</p>
      </div>
    }

    <!-- Sin productos agregados -->
    @if (hasAvailableProducts && !hasProducts) {
      <div class="text-center py-6 sm:py-8 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
        <lucide-icon [img]="Plus" class="text-gray-400 mx-auto mb-2" size="24"></lucide-icon>
        <p class="text-gray-600 mb-3 text-sm sm:text-base px-4">Agrega productos a este lote</p>
        <button
          type="button"
          (click)="addProduct()"
          class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg text-sm sm:text-base">
          Agregar primer producto
        </button>
      </div>
    }

    <!-- Lista de productos -->
    @if (hasProducts) {
      <div formArrayName="products" class="space-y-4">
        @for (productGroup of productsArray.controls; track $index; let i = $index) {
          <div [formGroupName]="i" class="bg-gray-50 p-4 rounded-lg">
            <div class="flex items-start gap-4">

              <!-- Selector de producto -->
              <div class="flex-1">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Producto *
                </label>
                <select
                  formControlName="product_id"
                  [class]="'w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 ' +
                           (isProductFieldInvalid(i, 'product_id') ? 'border-red-500' : 'border-gray-300')">
                  <option [value]="null">Seleccionar producto</option>
                  @for (product of getAvailableProducts(i); track product.id) {
                    <option [value]="product.id">{{ product.name }} - S/ {{ product.price }}</option>
                  }
                </select>

                @if (isProductFieldInvalid(i, 'product_id')) {
                  <p class="mt-1 text-sm text-red-600">{{ getProductFieldError(i, 'product_id') }}</p>
                }
              </div>

              <!-- Cantidad -->
              <div class="w-32">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Cantidad *
                </label>
                <input
                  type="number"
                  formControlName="quantity"
                  min="1"
                  [class]="'w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 ' +
                           (isProductFieldInvalid(i, 'quantity') ? 'border-red-500' : 'border-gray-300')">

                @if (isProductFieldInvalid(i, 'quantity')) {
                  <p class="mt-1 text-sm text-red-600">{{ getProductFieldError(i, 'quantity') }}</p>
                }
              </div>

              <!-- Botón eliminar -->
              <div class="pt-7">
                <button
                  type="button"
                  (click)="removeProduct(i)"
                  class="p-2 text-red-600 hover:text-red-800 hover:bg-red-50 rounded-lg transition-colors">
                  <lucide-icon [img]="Trash2" size="16"></lucide-icon>
                </button>
              </div>
            </div>

            <!-- Información del producto seleccionado -->
            @if (productGroup.get('product_id')?.value) {
              @let selectedProduct = getSelectedProduct(productGroup.get('product_id')?.value);
              @if (selectedProduct) {
                <div class="mt-3 pt-3 border-t border-gray-200">
                  <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4 text-sm text-gray-600">
                    <span class="font-medium">{{ selectedProduct.name }}</span>
                    <div class="flex items-center gap-2 sm:gap-4">
                      <span>S/ {{ selectedProduct.price }}</span>
                      @if (productGroup.get('quantity')?.value) {
                        <span>•</span>
                        <span>{{ productGroup.get('quantity')?.value }} unidades</span>
                      }
                    </div>
                  </div>
                </div>
              }
            }
          </div>
        }

        <!-- Resumen total -->
        @if (getTotalQuantity() > 0) {
          <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
            <div class="flex items-center justify-between">
              <span class="font-medium text-orange-800">Total del lote:</span>
              <span class="font-bold text-orange-900">{{ getTotalQuantity() }} unidades</span>
            </div>
          </div>
        }
      </div>
    }
  </div>

  <!-- Botones de acción -->
  <div class="flex flex-col gap-3 sm:flex-row sm:gap-3 sm:justify-end pt-4 sm:pt-6 border-t border-gray-200">
    <button
      type="button"
      (click)="onCancel()"
      class="w-full sm:w-auto px-6 py-3 sm:py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg transition-colors text-sm sm:text-base font-medium">
      Cancelar
    </button>

    <button
      type="submit"
      [disabled]="batchForm.invalid || !hasProducts"
      class="w-full sm:w-auto px-6 py-3 sm:py-2 bg-orange-600 hover:bg-orange-700 disabled:bg-orange-400 text-white rounded-lg transition-colors flex items-center justify-center gap-2 text-sm sm:text-base font-medium">
      <lucide-icon [img]="Save" size="18"></lucide-icon>
      <span>{{ submitButton }}</span>
    </button>
  </div>

</form>
